@model IncidentViewModel

@{
    ViewData["Title"] = "Report Page";
}

@section Styles{

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" /> 

    <style>

        .div-form-child {
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            margin-top: 15px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            .form-group input, .form-group textarea, .form-group select {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                border: 2px solid black;
                border-radius: 10px;
            }

            .form-group textarea {
                height: 100px;
            }

    </style>
}


@section Scripts{

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>

        let controllerName = '@ViewContext.RouteData.Values["controller"]';

        let defaultLatitude = -23.55052;
        let defaultlongitude = -46.633308;
            
        let initialMarker;
        let currentMarker;

        if(navigator.geolocation){

            navigator.geolocation.getCurrentPosition(
                function(position){
                    let latitude = position.coords.latitude;
                    let longitude = position.coords.longitude;
                    initializeMap(latitude, longitude);
                },
                function(error){
                    initializeMap(defaultLatitude, defaultlongitude);
                }
            );            
        }
        else{
            initializeMap(defaultLatitude, defaultLongitude);
        }

        function initializeMap(latitude, longitude){

            let map = L.map('map').setView([latitude, longitude], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

            initialMarker = L.marker([latitude, longitude]).addTo(map) .bindPopup('Você está aqui!') .openPopup();

            map.on('click', function(e) { 
                var lat = e.latlng.lat; 
                var lng = e.latlng.lng;

                if (currentMarker) { 
                    map.removeLayer(currentMarker); 
                }

                if (initialMarker) {
                    map.removeLayer(initialMarker);
                }

                currentMarker = L.marker([lat, lng]).addTo(map).bindPopup('Novo marcador adicionado!').openPopup();

                document.querySelector("#lat").value = lat;
                document.querySelector("#lng").value = lng;

            });
        }

        $(document).ready(function(){
            
            $('form').on('submit', function(event){
                event.preventDefault();

                let actionUrl = `/${controllerName}/Create`;

                $.ajax({
                    type: 'POST',
                    url: actionUrl,
                    data: $(this).serialize(),
                    success: function(response){
                        console.log("Resp: " + response)
                        $('#confirmationModal').modal('show');
                    }
                });
            });
        });

    </script>
}

<div class="d-flex justify-content-center align-items-center ctn-main">
    <div class="container">
        <div class="row">
            <div class="col text-center div-form">   
                
                <div class="div-form-child">
                    <h5>Formulário</h5>
                    <form action="Create" method="post">

                        <div class="form-group">
                            <label asp-for="Incident.CategoryId">Categoria</label>
                            <select asp-for="Incident.CategoryId" asp-items="Model.Categories" class="custom-select">
                                <option value="">Selecione uma categoria</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label asp-for="Incident.Description">Descrição</label>
                            <input asp-for="Incident.Description" />
                        </div>

                        <div class="form-group">
                            <label>Localização</label>
                            <div id="map" style="height: 500px;"></div>
                        </div>

                        <input id="lat" type="hidden" asp-for="Location.Latitude" />
                        <input id="lng" type="hidden" asp-for="Location.Longitude" />

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Reportar</button>
                        </div>

                    </form>

                    <div class="form-group div-bo">
                        <p>Já registrou o boletim de ocorrência?  Para registrar, <a href="https://servicos.sds.pe.gov.br/delegacia/" target="_blank">clique aqui</a>
                    </div>

                </div>

            </div>
            
        </div>
    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Confirmação</h5> 
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body"> Incidente criado com sucesso! </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmButton">OK</button>
            </div>
        </div>
    </div>
</div>